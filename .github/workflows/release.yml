name: Build and Release

on:
  push:
    tags:
      - "v*"

jobs:
  release:
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install create-dmg tool
        run: brew install create-dmg

      - name: Build Universal Binary
        run: |
          swift build -c release --arch arm64 --arch x86_64

      - name: Create App Bundle Structure
        run: |
          # Define variables
          APP_NAME="PRTracker.app"
          BINARY_NAME="PRTracker"
          
          mkdir -p "$APP_NAME/Contents/MacOS"
          mkdir -p "$APP_NAME/Contents/Resources"

          # Copy Universal Binary
          cp .build/apple/Products/Release/$BINARY_NAME "$APP_NAME/Contents/MacOS/"

          # Copy Info.plist
          if [ -f "Sources/Info.plist" ]; then
            cp Sources/Info.plist "$APP_NAME/Contents/Info.plist"
          else
            echo "Warning: Sources/Info.plist not found"
            exit 1
          fi

          # Copy App Icon if it exists
          if [ -f "Sources/Resources/AppIcon.icns" ]; then
            cp Sources/Resources/AppIcon.icns "$APP_NAME/Contents/Resources/"
          fi

      - name: Clean Extended Attributes and Quarantine
        run: |
          # Removing attributes to ensure the bundle is clean before packaging
          sudo xattr -rd com.apple.quarantine PRTracker.app || true
          xattr -rc PRTracker.app || true

      - name: Ad-hoc Code Sign
        run: |
          # Ad-hoc signing helps prevent macOS from flagging the binary as corrupted
          codesign --force --deep --sign - PRTracker.app

      - name: Create Professional DMG
        run: |
          # Remove existing DMG if it exists
          rm -f PRTracker.dmg
          
          # Create DMG with Applications folder shortcut
          create-dmg \
            --volname "PRTracker Installer" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "PRTracker.app" 175 120 \
            --hide-extension "PRTracker.app" \
            --app-drop-link 425 120 \
            "PRTracker.dmg" \
            "PRTracker.app"

      - name: Upload Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: PRTracker.dmg
          draft: false
          prerelease: false
          body: |
            ## ğŸ“¦ InstalaciÃ³n en macOS
            
            ### âš ï¸ Importante - Primera vez
            Esta aplicaciÃ³n no estÃ¡ firmada con Developer ID de Apple. Sigue estos pasos:
            
            ### âœ… MÃ©todo Recomendado (Control+Clic):
            
            1. **Descargar** `PRTracker.dmg`
            2. **Abrir** el DMG y arrastrar PRTracker a la carpeta **Aplicaciones**
            3. **Ir a la carpeta Aplicaciones** (Finder > Aplicaciones)
            4. **Control+Clic** (o clic derecho) en **PRTracker.app**
            5. Seleccionar **"Abrir"** del menÃº contextual
            6. En el diÃ¡logo, hacer clic en **"Abrir"**
            7. âœ¨ Â¡Listo! La prÃ³xima vez se abrirÃ¡ con doble clic normalmente
            
            ### ğŸ”§ MÃ©todo Alternativo (Terminal):
            Si el mÃ©todo anterior no funciona:
            ```bash
            xattr -d com.apple.quarantine /Applications/PRTracker.app
            ```
            
            ### ğŸ“± MÃ©todo 3 (Preferencias del Sistema):
            - Intenta abrir PRTracker normalmente
            - Ve a **ConfiguraciÃ³n del Sistema** > **Privacidad y Seguridad**
            - Busca el mensaje sobre PRTracker y clic en **"Abrir de todas formas"**
            
            ---
            
            ### ğŸ›¡ï¸ Â¿Es seguro?
            SÃ­, puedes revisar el cÃ³digo fuente completo en este repositorio.
            La aplicaciÃ³n es open source y construida automÃ¡ticamente por GitHub Actions.
