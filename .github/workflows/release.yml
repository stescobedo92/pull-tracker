name: Build and Release

on:
  push:
    tags:
      - "v*"

jobs:
  release:
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install create-dmg tool
        run: brew install create-dmg

      - name: Build Universal Binary
        run: |
          swift build -c release --arch arm64 --arch x86_64

      - name: Create App Bundle Structure
        run: |
          # Define variables
          APP_NAME="PRTracker.app"
          BINARY_NAME="PRTracker"
          
          mkdir -p "$APP_NAME/Contents/MacOS"
          mkdir -p "$APP_NAME/Contents/Resources"

          # Copy Universal Binary
          cp .build/apple/Products/Release/$BINARY_NAME "$APP_NAME/Contents/MacOS/"

          # Copy Info.plist
          if [ -f "Sources/Info.plist" ]; then
            cp Sources/Info.plist "$APP_NAME/Contents/Info.plist"
          else
            echo "Warning: Sources/Info.plist not found"
            exit 1
          fi

          # Copy App Icon if it exists
          if [ -f "Sources/Resources/AppIcon.icns" ]; then
            cp Sources/Resources/AppIcon.icns "$APP_NAME/Contents/Resources/"
          fi

      - name: Clean Extended Attributes and Quarantine
        run: |
          # Removing attributes to ensure the bundle is clean before packaging
          sudo xattr -rd com.apple.quarantine PRTracker.app || true
          xattr -rc PRTracker.app || true

      - name: Ad-hoc Code Sign
        run: |
          # Ad-hoc signing helps prevent macOS from flagging the binary as corrupted
          codesign --force --deep --sign - PRTracker.app

      - name: Create Professional DMG
        run: |
          # Remove existing DMG if it exists
          rm -f PRTracker.dmg
          
          # Create DMG with Applications folder shortcut
          create-dmg \
            --volname "PRTracker Installer" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "PRTracker.app" 175 120 \
            --hide-extension "PRTracker.app" \
            --app-drop-link 425 120 \
            "PRTracker.dmg" \
            "PRTracker.app"

      - name: Upload Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: PRTracker.dmg
          draft: false
          prerelease: false
          body: |
            ## üì¶ macOS Installation
            
            ### ‚ö†Ô∏è Important - First Time
            This application is not signed with an Apple Developer ID. Follow these steps:
            
            ### ‚úÖ Recommended Method (Control+Click):
            
            1. **Download** `PRTracker.dmg`
            2. **Open** the DMG and drag PRTracker to the **Applications** folder
            3. **Go to the Applications folder** (Finder > Applications)
            4. **Control+Click** (or right-click) on **PRTracker.app**
            5. Select **"Open"** from the context menu
            6. In the dialog, click **"Open"**
            7. ‚ú® Done! Next time it will open normally with double-click
            
            ### üîß Alternative Method (Terminal):
            If the previous method doesn't work:
            ```bash
            xattr -d com.apple.quarantine /Applications/PRTracker.app
            ```
            
            ### üì± Method 3 (System Preferences):
            - Try to open PRTracker normally
            - Go to **System Settings** > **Privacy & Security**
            - Look for the message about PRTracker and click **"Open Anyway"**
            
            ---
            
            ### üõ°Ô∏è Is it safe?
            Yes, you can review the complete source code in this repository.
            The application is open source and built automatically by GitHub Actions.
