name: Build and Release

on:
  push:
    tags:
      - "v*"

jobs:
  release:
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Universal Binary
        run: |
          swift build -c release --arch arm64 --arch x86_64

      - name: Create App Bundle
        run: |
          mkdir -p PRTracker.app/Contents/MacOS
          mkdir -p PRTracker.app/Contents/Resources

          # Copy Binary
          cp .build/apple/Products/Release/PRTracker PRTracker.app/Contents/MacOS/

          # Copy Info.plist
          cp Sources/Info.plist PRTracker.app/Contents/Info.plist

          # Copy Resources (Icon)
          cp Sources/Resources/AppIcon.icns PRTracker.app/Contents/Resources/

          # Verify bundle structure
          ls -R PRTracker.app

      - name: Create DMG
        run: |
          hdiutil create -volname "PRTracker" -srcfolder "PRTracker.app" -ov -format UDZO "PRTracker.dmg"

      - name: Upload Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: PRTracker.dmg
          draft: false
          prerelease: false
