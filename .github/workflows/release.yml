name: Build and Release

on:
  push:
    tags:
      - "v*"

jobs:
  release:
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install create-dmg tool
        run: brew install create-dmg

      - name: Build Universal Binary
        run: |
          swift build -c release --arch arm64 --arch x86_64

      - name: Create App Bundle Structure
        run: |
          # Define variables
          APP_NAME="PRTracker.app"
          BINARY_NAME="PRTracker"
          
          mkdir -p "$APP_NAME/Contents/MacOS"
          mkdir -p "$APP_NAME/Contents/Resources"

          # Copy Universal Binary
          cp .build/apple/Products/Release/$BINARY_NAME "$APP_NAME/Contents/MacOS/"

          # Copy Info.plist
          if [ -f "Sources/Info.plist" ]; then
            cp Sources/Info.plist "$APP_NAME/Contents/Info.plist"
          else
            echo "Warning: Sources/Info.plist not found, creating a basic one."
            cat > "$APP_NAME/Contents/Info.plist" <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>CFBundleExecutable</key>
    <string>PRTracker</string>
    <key>CFBundleIdentifier</key>
    <string>com.youruser.PRTracker</string>
    <key>CFBundleName</key>
    <string>PRTracker</string>
    <key>CFBundlePackageType</key>
    <string>APPL</string>
    <key>CFBundleShortVersionString</key>
    <string>1.0.1</string>
    <key>LSMinimumSystemVersion</key>
    <string>11.0</string>
</dict>
</plist>
EOF
          fi

          # Copy App Icon if it exists
          if [ -f "Sources/Resources/AppIcon.icns" ]; then
            cp Sources/Resources/AppIcon.icns "$APP_NAME/Contents/Resources/"
          fi

      - name: Clean Extended Attributes and Quarantine
        run: |
          # Removing attributes to ensure the bundle is clean before packaging
          sudo xattr -rd com.apple.quarantine PRTracker.app || true
          xattr -rc PRTracker.app || true

      - name: Ad-hoc Code Sign
        run: |
          # Ad-hoc signing helps prevent macOS from flagging the binary as corrupted
          codesign --force --deep --sign - PRTracker.app

      - name: Create Professional DMG
        run: |
          # Remove existing DMG if it exists
          rm -f PRTracker.dmg
          
          # Create DMG with Applications folder shortcut
          create-dmg \
            --volname "PRTracker Installer" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "PRTracker.app" 175 120 \
            --hide-extension "PRTracker.app" \
            --app-drop-link 425 120 \
            "PRTracker.dmg" \
            "PRTracker.app"

      - name: Upload Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: PRTracker.dmg
          draft: false
          prerelease: false
          body: |
            ## üì¶ Instalaci√≥n en macOS
            
            ### ‚ö†Ô∏è Importante - Primera vez
            Esta aplicaci√≥n no est√° firmada con Developer ID de Apple. Sigue estos pasos:
            
            ### ‚úÖ M√©todo Recomendado (Control+Clic):
            
            1. **Descargar** `PRTracker.dmg`
            2. **Abrir** el DMG y arrastrar PRTracker a la carpeta **Aplicaciones**
            3. **Ir a la carpeta Aplicaciones** (Finder > Aplicaciones)
            4. **Control+Clic** (o clic derecho) en **PRTracker.app**
            5. Seleccionar **"Abrir"** del men√∫ contextual
            6. En el di√°logo, hacer clic en **"Abrir"**
            7. ‚ú® ¬°Listo! La pr√≥xima vez se abrir√° con doble clic normalmente
            
            ### üîß M√©todo Alternativo (Terminal):
            Si el m√©todo anterior no funciona:
            ```bash
            xattr -d com.apple.quarantine /Applications/PRTracker.app
            ```
            
            ### üì± M√©todo 3 (Preferencias del Sistema):
            - Intenta abrir PRTracker normalmente
            - Ve a **Configuraci√≥n del Sistema** > **Privacidad y Seguridad**
            - Busca el mensaje sobre PRTracker y clic en **"Abrir de todas formas"**
            
            ---
            
            ### üõ°Ô∏è ¬øEs seguro?
            S√≠, puedes revisar el c√≥digo fuente completo en este repositorio.
            La aplicaci√≥n es open source y construida autom√°ticamente por GitHub Actions.
